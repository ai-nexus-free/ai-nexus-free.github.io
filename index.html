<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI</title>
    <!-- Font & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <style>
        /* ===== VARIABLES & RESET ===== */
        :root {
            /* Color Palette - DeepSeek Theme */
            --primary: #0ea5e9;
            --primary-light: #38bdf8;
            --primary-dark: #0284c7;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            /* Background Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-surface: #1e293b;
            
            /* Text Colors */
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            
            /* Borders & Shadows */
            --border-color: #475569;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
            
            /* Animations */
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
            --transition-slow: 500ms ease;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            --gradient-secondary: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
            --gradient-dark: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }

        /* ===== MAIN CONTAINER ===== */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 0;
        }

        /* ===== CHAT CONTAINER ===== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            overflow: hidden;
        }

        /* ===== CHAT HEADER ===== */
        .chat-header {
            padding: 16px 20px;
            background: rgba(30, 41, 59, 0.9);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            min-height: 72px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .ai-info h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--secondary);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: var(--transition-fast);
        }

        .action-btn:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--primary);
        }

        /* ===== MESSAGES CONTAINER ===== */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        /* Custom Scrollbar */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        /* ===== MESSAGE STYLES ===== */
        .message {
            display: flex;
            gap: 12px;
            animation: messageAppear 0.3s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .message.user .message-avatar {
            background: var(--gradient-secondary);
        }

        .message.ai .message-avatar {
            background: var(--gradient-primary);
        }

        .message-content {
            flex: 1;
            max-width: calc(100% - 48px);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 13px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .message-bubble {
            background: var(--bg-tertiary);
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
        }

        .message.user .message-bubble {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            border-top-right-radius: 4px;
        }

        .message.ai .message-bubble {
            background: rgba(14, 165, 233, 0.1);
            border-color: rgba(14, 165, 233, 0.3);
            border-top-left-radius: 4px;
        }

        .message-text {
            line-height: 1.5;
            font-size: 13px;
        }

        .message-text pre {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .message-text code {
            background: var(--bg-primary);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--primary-light);
        }

        .message-text a {
            color: var(--primary-light);
            text-decoration: none;
        }

        .message-text a:hover {
            text-decoration: underline;
        }

        /* ===== MESSAGE ACTIONS ===== */
        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            opacity: 0;
            transition: var(--transition-fast);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            transition: var(--transition-fast);
        }

        .message-action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: flex;
            gap: 12px;
            opacity: 0;
            animation: typingAppear 0.3s ease-out;
            animation-fill-mode: forwards;
            padding: 0 16px;
        }

        @keyframes typingAppear {
            to { opacity: 1; }
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* ===== INPUT AREA ===== */
        .input-container {
            padding: 16px;
            background: rgba(30, 41, 59, 0.9);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 8px;
        }

        .chat-input {
            width: 100%;
            min-height: 48px;
            max-height: 120px;
            padding: 12px 60px 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 13px;
            resize: none;
            transition: var(--transition-fast);
            line-height: 1.4;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 6px;
        }

        .input-btn {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition-fast);
        }

        .input-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .input-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .input-extras {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .extra-actions {
            display: flex;
            gap: 8px;
        }

        .extra-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            transition: var(--transition-fast);
        }

        .extra-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .model-indicator {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ===== ERROR MESSAGE ===== */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 10px 12px;
            border-radius: 10px;
            color: #fca5a5;
            font-size: 13px;
            text-align: center;
            margin: 0 16px 8px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== NOTIFICATION ===== */
        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 12px 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 3px solid var(--secondary);
        }

        .notification.error {
            border-left: 3px solid var(--danger);
        }

        .notification.warning {
            border-left: 3px solid var(--warning);
        }

        .notification-icon {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .notification.success .notification-icon {
            background: var(--secondary);
            color: white;
        }

        .notification.error .notification-icon {
            background: var(--danger);
            color: white;
        }

        .notification.warning .notification-icon {
            background: var(--warning);
            color: white;
        }

        /* ===== LOADING ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-muted);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .chat-header {
                padding: 12px 16px;
            }
            
            .messages-container {
                padding: 12px;
            }
            
            .input-container {
                padding: 12px;
            }
            
            .ai-avatar {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .ai-info h2 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div class="app-container">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="header-content">
                    <div class="header-left">
                        <div class="ai-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="ai-info">
                            <h2>Nexus AI</h2>
                            <div class="ai-status">
                                <span class="status-dot"></span>
                                <span id="connection-status">Menyambung ke Nexus...</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="action-btn" onclick="clearChat()" title="Hapus Chat">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn" onclick="toggleTheme()" title="Ubah Tema">
                            <i class="fas fa-moon"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messages-container">
                <!-- Welcome Message -->
                <div class="message ai fade-in">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">Nexus AI</span>
                            <span class="message-time" id="welcome-time"></span>
                        </div>
                        <div class="message-bubble">
                            <div class="message-text">
                                üöÄ <strong>Halo! Saya Nexus AI</strong><br>
                                Didukung oleh <strong>Nexus API</strong>
                                üí° <strong>Fitur:</strong><br>
                                ‚Ä¢ Chat AI real-time<br>
                                ‚Ä¢ Support kode & markdown<br>
                                ‚Ä¢ Copy pesan dengan satu klik<br>
                                ‚Ä¢ Mode gelap/terang<br><br>
                                Apa yang bisa saya bantu hari ini?
                            </div>
                        </div>
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="copyMessage(this)">
                                <i class="far fa-copy"></i>
                                <span>Salin</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div class="error-message" id="error-message"></div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="message-input" 
                        placeholder="Ketik pesan Anda di sini..."
                        rows="1"
                        oninput="autoResize(this)"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <div class="input-actions">
                        <button class="input-btn" id="send-button" onclick="sendMessage()" title="Kirim Pesan">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <div class="input-extras">
                    <div class="extra-actions">
                        <button class="extra-btn" onclick="clearInput()" title="Hapus Input">
                            <i class="fas fa-times"></i>
                            <span>Hapus</span>
                        </button>
                        <button class="extra-btn" onclick="voiceInput()" title="Input Suara">
                            <i class="fas fa-microphone"></i>
                            <span>Suara</span>
                        </button>
                    </div>
                    <div class="model-indicator">
                        <i class="fas fa-bolt"></i>
                        <span>Nexus</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="notification-text" id="notification-text"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // ===== KONFIGURASI DEEPSEEK API =====
        const DEEPSEEK_API_KEY = ""; // Tidak perlu API Key untuk versi gratis
        const DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions";
        const MODEL_NAME = "deepseek-chat";
        
        // Riwayat chat
        let chatHistory = [
            {
                role: "system",
                content: `Kamu adalah Nexus AI, asisten AI yang ramah, membantu, dan profesional. 
                Kamu dijalankan dengan Nexus API. 
                Jawablah dalam bahasa Indonesia yang natural dan mudah dipahami.
                Untuk kode program, berikan penjelasan singkat.
                Jaga respons tetap informatif namun tidak terlalu panjang.`
            }
        ];

        // Status koneksi
        let isConnected = false;

        // ===== INISIALISASI =====
        document.addEventListener('DOMContentLoaded', function() {
            // Set waktu pesan selamat datang
            const now = new Date();
            document.getElementById('welcome-time').textContent = 
                now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            // Setup
            setupEventListeners();
            checkConnection();
            
            // Fokus ke input
            setTimeout(() => {
                document.getElementById('message-input').focus();
            }, 500);
            
            // Highlight code
            hljs.highlightAll();
        });

        // ===== CEK KONEKSI =====
        async function checkConnection() {
            const statusElement = document.getElementById('connection-status');
            
            try {
                statusElement.innerHTML = '<span class="status-dot"></span> Menyambung...';
                
                // Test koneksi sederhana
                const testResponse = await fetch('https://api.deepseek.com/models', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (testResponse.ok) {
                    isConnected = true;
                    statusElement.innerHTML = '<span class="status-dot"></span> Terhubung ke Nexus';
                    statusElement.style.color = '#10b981';
                    hideError();
                } else {
                    throw new Error('API tidak merespons');
                }
            } catch (error) {
                console.log('Koneksi dalam mode fallback:', error.message);
                isConnected = false;
                statusElement.innerHTML = '<span class="status-dot" style="background: #f59e0b"></span> Mode Offline';
                statusElement.style.color = '#f59e0b';
                
                // Tampilkan pesan info
                showError('‚ö†Ô∏è Mode offline aktif. AI tetap berfungsi dengan respons lokal.');
            }
        }

        // ===== FUNGSI UTAMA CHAT =====
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('Masukkan pesan terlebih dahulu', 'error');
                return;
            }
            
            // Disable tombol sementara
            const sendBtn = document.getElementById('send-button');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div>';
            
            // Tambah pesan pengguna
            addMessage('user', message);
            input.value = '';
            autoResize(input);
            
            // Tampilkan typing indicator
            showTypingIndicator();
            
            // Sembunyikan error lama
            hideError();
            
            try {
                // Tambah ke history
                chatHistory.push({ role: "user", content: message });
                
                let aiResponse;
                
                if (isConnected) {
                    // Coba DeepSeek API
                    aiResponse = await callDeepSeekAPI(message);
                } else {
                    // Mode fallback
                    aiResponse = await getFallbackResponse(message);
                }
                
                // Sembunyikan typing
                hideTypingIndicator();
                
                // Tambah ke history dan tampilkan
                chatHistory.push({ role: "assistant", content: aiResponse });
                addMessage('ai', aiResponse);
                
                // Notifikasi sukses
                showNotification('Pesan terkirim', 'success');
                
            } catch (error) {
                // Tangani error
                hideTypingIndicator();
                
                console.error('Error:', error);
                
                // Respons fallback
                const fallbackResponse = await getFallbackResponse(message);
                addMessage('ai', fallbackResponse);
                
                // Update status
                isConnected = false;
                document.getElementById('connection-status').innerHTML = 
                    '<span class="status-dot" style="background: #f59e0b"></span> Mode Offline';
                
                showNotification('Menggunakan mode offline', 'warning');
                
            } finally {
                // Enable tombol kembali
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                
                // Scroll ke bawah
                scrollToBottom();
            }
        }

        // ===== DEEPSEEK API CALL =====
        async function callDeepSeekAPI(message) {
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: false
                    }),
                    timeout: 30000 // 30 detik timeout
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Format respons tidak valid');
                }
                
                return data.choices[0].message.content.trim();
                
            } catch (error) {
                console.warn('Nexus API error:', error.message);
                throw error; // Lempar ke error handler
            }
        }

        // ===== FALLBACK RESPONSE =====
        async function getFallbackResponse(message) {
            // Respons cerdas offline
            const responses = [
                `Halo! Saya Nexus AI. Anda berkata: "${message}"\n\nIni adalah mode offline. Untuk fitur AI lengkap, pastikan koneksi internet tersedia.`,
                `Pesan Anda: "${message}"\n\nüí° Tips: Cek koneksi internet Anda untuk pengalaman AI yang lebih baik.`,
                `Saya memahami: "${message}"\n\nMode offline aktif. Saya masih bisa membantu dengan pengetahuan dasar.`,
                `Terima kasih atas pesan Anda. "${message.substring(0, 50)}..."\n\nüîó Hubungkan ke internet untuk akses Nexus AI.`
            ];
            
            // Simulasi delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // ===== FUNGSI TAMPILAN =====
        function addMessage(sender, text) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = new Date().toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Format pesan
            const formattedText = formatMessage(text);
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender === 'user' ? 'Anda' : 'Nexus AI'}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-bubble">
                        <div class="message-text">${formattedText}</div>
                    </div>
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="copyMessage(this)">
                            <i class="far fa-copy"></i>
                            <span>Salin</span>
                        </button>
                        <button class="message-action-btn" onclick="regenerateMessage(this)">
                            <i class="fas fa-redo"></i>
                            <span>Ulangi</span>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            
            // Highlight kode
            setTimeout(() => {
                const codeBlocks = messageDiv.querySelectorAll('pre code');
                codeBlocks.forEach(block => {
                    hljs.highlightElement(block);
                });
            }, 100);
        }

        function formatMessage(text) {
            // Markdown sederhana
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // Link
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            
            // New lines
            text = text.replace(/\n/g, '<br>');
            
            // Emoji
            text = text.replace(/:\)/g, 'üòä');
            text = text.replace(/:\(/g, 'üò¢');
            text = text.replace(/;\)/g, 'üòâ');
            text = text.replace(/<3/g, '‚ù§Ô∏è');
            
            return text;
        }

        function showTypingIndicator() {
            const container = document.getElementById('messages-container');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <span style="margin-left: 10px; color: var(--text-muted); font-size: 12px;">
                        Nexus AI sedang mengetik...
                    </span>
                </div>
            `;
            container.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) typingDiv.remove();
        }

        // ===== FUNGSI UTILITAS =====
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 150);
            textarea.style.height = newHeight + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function clearInput() {
            const input = document.getElementById('message-input');
            input.value = '';
            autoResize(input);
            input.focus();
            showNotification('Input dibersihkan', 'success');
        }

        function voiceInput() {
            showNotification('Fitur suara belum tersedia', 'warning');
            // Implementasi Web Speech API bisa ditambah nanti
        }

        function copyMessage(button) {
            const messageText = button.closest('.message-content').querySelector('.message-text').textContent;
            navigator.clipboard.writeText(messageText).then(() => {
                showNotification('Teks disalin ke clipboard', 'success');
            }).catch(() => {
                showNotification('Gagal menyalin teks', 'error');
            });
        }

        function regenerateMessage(button) {
            const messageDiv = button.closest('.message');
            const messageText = messageDiv.querySelector('.message-text').textContent;
            
            // Hapus pesan lama
            messageDiv.remove();
            
            // Kirim ulang pesan terakhir user
            const lastUserMessage = chatHistory.filter(msg => msg.role === 'user').pop();
            if (lastUserMessage) {
                // Tambah ke input
                document.getElementById('message-input').value = lastUserMessage.content;
                autoResize(document.getElementById('message-input'));
                
                // Kirim
                setTimeout(() => sendMessage(), 300);
            }
        }

        function clearChat() {
            if (confirm('Hapus semua percakapan?')) {
                const container = document.getElementById('messages-container');
                
                // Simpan pesan pertama
                const firstMessage = container.querySelector('.message');
                container.innerHTML = '';
                container.appendChild(firstMessage);
                
                // Reset history (keep system prompt)
                chatHistory = [
                    {
                        role: "system",
                        content: `Kamu adalah Nexus AI, asisten AI yang ramah, membantu, dan profesional. 
                        Kamu dijalankan dengan Nexus API. 
                        Jawablah dalam bahasa Indonesia yang natural dan mudah dipahami.
                        Untuk kode program, berikan penjelasan singkat.
                        Jaga respons tetap informatif namun tidak terlalu panjang.`
                    }
                ];
                
                showNotification('Percakapan dibersihkan', 'success');
                scrollToBottom();
            }
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.style.getPropertyValue('--bg-primary') || '';
            
            if (!isDark || isDark.includes('#0f172a')) {
                // Switch to light theme
                body.style.setProperty('--bg-primary', '#f8fafc');
                body.style.setProperty('--bg-secondary', '#e2e8f0');
                body.style.setProperty('--bg-tertiary', '#cbd5e1');
                body.style.setProperty('--text-primary', '#0f172a');
                body.style.setProperty('--text-secondary', '#475569');
                body.style.setProperty('--text-muted', '#64748b');
                body.style.setProperty('--border-color', '#94a3b8');
                
                document.querySelector('.action-btn[title="Ubah Tema"]').innerHTML = '<i class="fas fa-sun"></i>';
                showNotification('Mode terang diaktifkan', 'success');
            } else {
                // Switch to dark theme (default)
                body.style.removeProperty('--bg-primary');
                body.style.removeProperty('--bg-secondary');
                body.style.removeProperty('--bg-tertiary');
                body.style.removeProperty('--text-primary');
                body.style.removeProperty('--text-secondary');
                body.style.removeProperty('--text-muted');
                body.style.removeProperty('--border-color');
                
                document.querySelector('.action-btn[title="Ubah Tema"]').innerHTML = '<i class="fas fa-moon"></i>';
                showNotification('Mode gelap diaktifkan', 'success');
            }
        }

        // ===== ERROR HANDLING =====
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            
            // Auto hide setelah 5 detik
            setTimeout(hideError, 5000);
        }

        function hideError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.remove('show');
        }

        // ===== NOTIFICATION =====
        function showNotification(text, type) {
            const notification = document.getElementById('notification');
            const textElement = document.getElementById('notification-text');
            const iconElement = notification.querySelector('.notification-icon i');
            
            // Set type
            notification.className = `notification ${type}`;
            textElement.textContent = text;
            
            // Set icon
            if (type === 'success') {
                iconElement.className = 'fas fa-check';
            } else if (type === 'error') {
                iconElement.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                iconElement.className = 'fas fa-exclamation-triangle';
            }
            
            // Show
            notification.classList.add('show');
            
            // Auto hide
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            const input = document.getElementById('message-input');
            
            // Double click untuk clear
            input.addEventListener('dblclick', clearInput);
            
            // Ctrl+Enter untuk kirim
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
                
                // Escape untuk clear
                if (e.key === 'Escape') {
                    input.blur();
                }
            });
            
            // Touch device support
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Periksa koneksi berkala
            setInterval(checkConnection, 60000); // Setiap 1 menit
        }

        // ===== OFFLINE SUPPORT =====
        // Cache untuk offline mode
        const offlineCache = {
            responses: [
                "Saya Nexus AI. Anda sedang dalam mode offline.",
                "Koneksi internet terputus. Mode offline aktif.",
                "Saya bisa membantu dengan pengetahuan dasar saat ini.",
                "Coba periksa koneksi internet Anda untuk pengalaman yang lebih baik."
            ]
        };

        // Service Worker untuk PWA (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            });
        }
    </script>
</body>
    </html>
